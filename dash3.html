<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS | Prototype Final</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #121212;
            --card-border: #333;
            --accent-green: #00e054;
            --accent-red: #ff2d2d;
            --accent-blue: #3e64ff;
            --text-primary: #ffffff;
            --text-secondary: #8b8b8b;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        /* Layout Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .card-title {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        /* SENSOR METRICS (Left) */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }
        .metric-value { font-size: 28px; font-weight: 600; }
        .metric-unit { font-size: 14px; color: var(--text-secondary); }

        /* CENTER VIZ */
        .main-viz {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .soc-ring {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            border: 6px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 50px rgba(0, 224, 84, 0.05);
            margin-bottom: 20px;
            transition: all 0.5s;
        }
        
        /* Dynamic border for SOC */
        .soc-ring.charging { border-color: var(--accent-green); box-shadow: 0 0 50px rgba(0, 224, 84, 0.3); }
        .soc-ring.alert { border-color: var(--accent-red); box-shadow: 0 0 50px rgba(255, 45, 45, 0.4); }

        .soc-text { font-size: 70px; font-weight: 700; }
        
        /* PERFORMANCE SECTION (Right Panel Top) */
        .perf-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .perf-bar-bg { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 20px; }
        .perf-bar-fill { width: 98%; height: 100%; background: var(--accent-blue); border-radius: 2px; }

        /* BUTTONS (Right Panel Bottom) */
        .control-btn {
            background: #222;
            color: white;
            border: 1px solid #444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 600;
        }

        .control-btn:hover { background: #333; transform: translateX(5px); }
        
        .btn-green.active { background: var(--accent-green); color: black; border-color: var(--accent-green); }
        .btn-blue { border-color: var(--accent-blue); color: var(--accent-blue); }
        .btn-blue:hover { background: var(--accent-blue); color: white; }
        
        .btn-red { border-color: var(--accent-red); color: var(--accent-red); margin-top: auto; }
        .btn-red:hover { background: var(--accent-red); color: white; }

        /* ML Graph Area */
        #ml-overlay {
            grid-column: 1 / -1;
            background: #111;
            border-top: 1px solid #333;
            padding: 20px;
            display: none; 
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

    </style>
</head>
<body>

    <header>
        <div>
            <h1 style="margin:0; font-size:22px; letter-spacing:1px;">BATTERY HEALTH MONITOR</h1>
            <span style="font-size:12px; color:#666;">BMS PROTOTYPE</span>
        </div>
        <div style="background:#111; padding:8px 16px; border-radius:20px; border:1px solid #333; font-size:12px; color:var(--accent-green);">
            ● SYSTEM ONLINE
        </div>
    </header>

    <div class="dashboard-grid">
        
        <div class="card">
            <div class="card-title">Live Sensors</div>
            
            <div class="metric-row">
                <span style="color:#aaa">VOLTAGE</span>
                <div><span id="volts" class="metric-value">3.72</span> <span class="metric-unit">V</span></div>
            </div>

            <div class="metric-row">
                <span style="color:#aaa">CURRENT</span>
                <div><span id="amps" class="metric-value">1.40</span> <span class="metric-unit">A</span></div>
            </div>

            <div class="metric-row" style="border:none;">
                <span style="color:#aaa">TEMP</span>
                <div><span id="temp" class="metric-value">31.0</span> <span class="metric-unit">°C</span></div>
            </div>

            <div style="margin-top:auto; background:#1a1a1a; padding:15px; border-radius:8px;">
                <div class="card-title" style="margin-bottom:5px;">Diagnostics Log</div>
                <div id="log-feed" style="font-family:monospace; font-size:11px; color:#888; height:80px; overflow:hidden;">
                    > Initializing sensors...<br>
                </div>
            </div>
        </div>

        <div class="card main-viz">
            <div id="main-ring" class="soc-ring">
                <div style="text-align: center;">
                    <div id="soc" class="soc-text">85</div>
                    <div style="color:#888; font-size:14px;">% CHARGE</div>
                </div>
            </div>
            
            <div style="text-align:center;">
                <div style="font-size:32px; font-weight:600;">
                    <span id="range-val">324</span> 
                    <span style="font-size:18px; color:#666;">km</span>
                </div>
                <div style="font-size:12px; color:#666; letter-spacing:1px; margin-top:5px;">ESTIMATED RANGE</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Health & Performance</div>

            <div class="perf-row">
                <span style="color:#aaa;">MAX CAPACITY</span>
                <span>98%</span>
            </div>
            <div class="perf-bar-bg"><div class="perf-bar-fill"></div></div>

            <div class="perf-row" style="margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #333;">
                <span style="color:#aaa;">PEAK PERFORMANCE</span>
                <span id="perf-status" style="color:var(--accent-green); font-weight:700;">STABLE</span>
            </div>

            <div class="card-title">Controls</div>

            <button id="btn-lpm" class="control-btn btn-green" onclick="toggleLPM()">
                <span>Low Power Mode</span>
                <span id="status-lpm">OFF</span>
            </button>

            <button class="control-btn btn-blue" onclick="toggleGraph()">
                <span>Run Smart Diagnostics</span>
                <span>▼</span>
            </button>

            <button class="control-btn" onclick="optimizeNow()">
                <span>Optimize Charging</span>
                <span>⚡</span>
            </button>

            <button class="control-btn btn-red" onclick="triggerDemoFault()">
                <span>! SIMULATE FAULT</span>
            </button>
        </div>

        <div id="ml-overlay" class="card">
            <div class="card-title" style="color:var(--accent-blue);">Neural Network Prediction</div>
            <div style="height: 200px; width: 100%;">
                <canvas id="mlChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        // We wrap everything in window.onload to make sure HTML is ready before JS runs
        window.onload = function() {
            
            // --- 1. SIMULATION LOOP ---
            setInterval(() => {
                // Randomly fluctuate values to look "Live"
                let v = (3.70 + Math.random() * 0.05).toFixed(2);
                let c = (1.35 + Math.random() * 0.10).toFixed(2);
                let t = (31.0 + Math.random() * 0.5).toFixed(1);
                
                // Safely update elements
                if(document.getElementById('volts')) document.getElementById('volts').innerText = v;
                if(document.getElementById('amps')) document.getElementById('amps').innerText = c;
                if(document.getElementById('temp')) document.getElementById('temp').innerText = t;

                // Random Log updates
                if(Math.random() > 0.90) {
                    addLog("Checking thermal status... OK");
                }
            }, 1500);

            // --- 2. BUTTON FUNCTIONS ---

            // Low Power Mode Variable
            window.lpmOn = false;

            window.toggleLPM = function() {
                window.lpmOn = !window.lpmOn;
                const btn = document.getElementById('btn-lpm');
                const status = document.getElementById('status-lpm');
                const rangeVal = document.getElementById('range-val');

                if(window.lpmOn) {
                    btn.classList.add('active');
                    status.innerText = "ON";
                    rangeVal.innerText = "365"; 
                    addLog("Low Power Mode Activated. Range extended.");
                } else {
                    btn.classList.remove('active');
                    status.innerText = "OFF";
                    rangeVal.innerText = "324"; 
                    addLog("Standard Performance Mode.");
                }
            }

            window.toggleGraph = function() {
                const overlay = document.getElementById('ml-overlay');
                if(!overlay) return;

                if(overlay.style.display === 'block') {
                    overlay.style.display = 'none';
                } else {
                    overlay.style.display = 'block';
                    try {
                        renderChart();
                    } catch(e) {
                        console.log("Chart failed to load", e);
                        addLog("Error: Chart library not loaded (Offline mode?)");
                    }
                    addLog("Running Diagnostic Neural Net...");
                }
            }

            window.optimizeNow = function() {
                addLog("Optimizing charging curve...");
                const ring = document.getElementById('main-ring');
                if(ring) {
                    ring.classList.add('charging');
                    setTimeout(() => {
                        ring.classList.remove('charging');
                        addLog("Optimization Complete.");
                    }, 2000);
                }
            }

            window.triggerDemoFault = function() {
                const ring = document.getElementById('main-ring');
                const perf = document.getElementById('perf-status');
                const volts = document.getElementById('volts');
                
                // Visual Alarms
                if(ring) ring.classList.add('alert');
                if(volts) volts.style.color = '#ff2d2d';
                
                // Update Peak Performance Status
                if(perf) {
                    perf.innerText = "LIMITED";
                    perf.style.color = "#ff2d2d";
                }

                addLog("!! ALERT: VOLTAGE SPIKE DETECTED !!");
                addLog("!! PERFORMANCE THROTTLED !!");
                
                setTimeout(() => {
                    if(ring) ring.classList.remove('alert');
                    if(volts) volts.style.color = 'white';
                    if(perf) {
                        perf.innerText = "STABLE";
                        perf.style.color = "#00e054";
                    }
                    addLog("System normalized.");
                }, 4000);
            }

            // Helper for logs
            function addLog(msg) {
                const log = document.getElementById('log-feed');
                if(log) {
                    log.innerHTML = "> " + msg + "<br>" + log.innerHTML;
                }
            }

            // --- 3. CHART RENDERING ---
            let chartInstance = null;
            function renderChart() {
                if(chartInstance) return;
                
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    addLog("Error: Internet required for ML Graph");
                    return;
                }

                const ctx = document.getElementById('mlChart').getContext('2d');
                
                let gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(62, 100, 255, 0.4)');
                gradient.addColorStop(1, 'rgba(62, 100, 255, 0.0)');

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Projected Health (SOH)',
                            data: [100, 99.8, 99.6, 99.4, 99.2, 99.1],
                            borderColor: '#3e64ff',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#666' } },
                            y: { grid: { color: '#333' }, ticks: { color: '#666' } }
                        }
                    }
                });
            }
        };
    </script>
</body>
</html>